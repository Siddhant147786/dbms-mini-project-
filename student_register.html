<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <header id="main-header"></header>

    <main class="container">
        <div class="form-container">
            <h2>Student Registration</h2>
            <div id="register-message" class="message" style="display:none;"></div>
            <form id="studentRegisterForm">
                <div class="form-group">
                    <label for="name">Full Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirm Password:</label>
                    <input type="password" id="confirm_password" name="confirm_password" required>
                </div>
                <div class="form-group">
                    <label for="roll_number">Roll Number:</label>
                    <input type="text" id="roll_number" name="roll_number" required>
                </div>
                <div class="form-group">
                    <label for="branch_id">Branch:</label>
                    <select id="branch_id" name="branch_id" required></select>
                </div>
                <div class="form-group">
                    <label for="year_id">Academic Year:</label>
                    <select id="year_id" name="year_id" required></select>
                </div>
                <div class="form-group">
                    <label for="semester_id">Semester:</label>
                    <select id="semester_id" name="semester_id" required></select>
                </div>
                <button type="submit" class="button primary button-full-width">Register</button>
            </form>
            <p class="text-center mt-30">Already have an account? <a href="student_login.html">Login here</a></p>
        </div>
    </main>

    <footer id="main-footer"></footer>

    <!-- All necessary JavaScript is now included directly in this file -->
    <script>
        // === Configuration ===
        const API_BASE_URL = 'http://127.0.0.1:5000';

        // === Utility Functions (self-contained) ===
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = message;
                element.className = `message ${type}`;
                element.style.display = 'block';
                setTimeout(() => { element.style.display = 'none'; }, 5000);
            }
        }

        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            };
            if (data) {
                options.body = JSON.stringify(data);
            }
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("API Call failed:", error);
                throw error;
            }
        }
        
        function populateSelect(selectElement, data, valueKey, textKey, defaultOption = "Select...") {
            if (!selectElement) return;
            selectElement.innerHTML = `<option value="">${defaultOption}</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueKey];
                option.textContent = item[textKey];
                selectElement.appendChild(option);
            });
        }

        function validateForm(form, rules) {
            let isValid = true;
            const errors = [];
            for (const fieldName in rules) {
                const input = form.elements[fieldName];
                const rule = rules[fieldName];
                if (!input) continue;
                if (rule.required && !input.value.trim()) {
                    isValid = false;
                    errors.push(`${rule.label || fieldName} is required.`);
                }
                if (rule.confirmWith && input.value !== form.elements[rule.confirmWith].value) {
                    isValid = false;
                    errors.push(`Passwords do not match.`);
                }
            }
            return { isValid, errors };
        }

        // === Page-Specific Logic ===
        document.addEventListener('DOMContentLoaded', async () => {
            // Render Header & Footer
            const headerElement = document.getElementById('main-header');
            if (headerElement) {
                headerElement.innerHTML = `<div class="container"><h1><a href="index.html">Feedback System</a></h1><nav><ul><li><a href="index.html">Home</a></li></ul></nav></div>`;
            }
            const footerElement = document.getElementById('main-footer');
            if (footerElement) {
                footerElement.innerHTML = `<div class="container"><p>&copy; ${new Date().getFullYear()} Faculty Feedback System. All rights reserved.</p></div>`;
            }

            const registerForm = document.getElementById('studentRegisterForm');
            const messageElementId = 'register-message';

            // Populate dropdowns from the API
            try {
                const data = await apiCall('/api/dropdowns', 'GET');
                populateSelect(document.getElementById('branch_id'), data.branches, 'id', 'name', 'Select Branch');
                populateSelect(document.getElementById('year_id'), data.years, 'id', 'label', 'Select Year');
                populateSelect(document.getElementById('semester_id'), data.semesters, 'id', 'label', 'Select Semester');
            } catch (error) {
                showMessage(messageElementId, 'Failed to load registration options. Please refresh the page.', 'error');
            }

            // Setup Form Submission
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = {
                    name: registerForm.elements.name.value,
                    email: registerForm.elements.email.value,
                    password: registerForm.elements.password.value,
                    roll_number: registerForm.elements.roll_number.value,
                    branch_id: parseInt(registerForm.elements.branch_id.value),
                    year_id: parseInt(registerForm.elements.year_id.value),
                    semester_id: parseInt(registerForm.elements.semester_id.value),
                };

                const validationRules = {
                    name: { required: true, label: 'Full Name' },
                    email: { required: true, label: 'Email' },
                    password: { required: true, label: 'Password' },
                    confirm_password: { required: true, confirmWith: 'password' },
                    roll_number: { required: true, label: 'Roll Number' },
                    branch_id: { required: true, label: 'Branch' },
                    year_id: { required: true, label: 'Academic Year' },
                    semester_id: { required: true, label: 'Semester' },
                };
                
                const { isValid, errors } = validateForm(registerForm, validationRules);

                if (!isValid) {
                    showMessage(messageElementId, errors.join('<br>'), 'error');
                    return;
                }

                try {
                    const response = await apiCall('/student/register', 'POST', formData);
                    if (response.status === 'success') {
                        showMessage(messageElementId, response.message + ' Redirecting to login...', 'success');
                        setTimeout(() => {
                            window.location.href = 'student_login.html';
                        }, 2000);
                    } else {
                        showMessage(messageElementId, response.message || 'Registration failed.', 'error');
                    }
                } catch (error) {
                    showMessage(messageElementId, error.message || 'An unexpected error occurred.', 'error');
                }
            });
        });
    </script>
</body>
</html>
